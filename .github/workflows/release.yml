name: Release Connector

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.1.0)"
        required: true
        type: string

env:
  CONNECTOR_NAME: promptql-posthog

jobs:
  compile-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile check
        run: |
          # Start the connector and check it starts successfully
          timeout 30s npm run start &
          PID=$!
          sleep 10
          # Check if process is still running (means it started ok)
          if kill -0 $PID 2>/dev/null; then
            echo "✓ Connector started successfully"
            kill $PID
          else
            echo "✗ Connector failed to start"
            exit 1
          fi

  release:
    runs-on: ubuntu-latest
    needs: compile-check
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set version
        id: version
        run: |
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          echo "connector=${{ env.CONNECTOR_NAME }}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Install dependencies
        run: npm ci

      - name: Build and package connector
        run: |
          mkdir -p dist

          # Copy all files/folders except node_modules, .git, .github, docs, *.md files
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='dist' \
            --exclude='docs' \
            --exclude='*.md' \
            --exclude-from='.gitignore' \
            . dist/

          # Create the release tarball
          shopt -s dotglob && cd dist && tar -czvf ../${{ steps.version.outputs.connector }}-connector-v${{ steps.version.outputs.version }}.tar.gz *

      - name: Generate package metadata
        id: package-metadata
        run: |
          # Calculate SHA256 checksum of the tarball
          CHECKSUM=$(sha256sum ${{ steps.version.outputs.connector }}-connector-v${{ steps.version.outputs.version }}.tar.gz | cut -d ' ' -f 1)

          # Get current commit hash
          COMMIT_HASH=$(git rev-parse HEAD)

          # Create the connector-packaging.json file with GCS link
          cat > connector-packaging.json << EOF
          {
            "version": "v${{ steps.version.outputs.version }}",
            "uri": "https://storage.googleapis.com/staging-connector-platform-registry/ndc-jdbc-assets/${{ steps.version.outputs.connector }}/${{ steps.version.outputs.version }}/${{ steps.version.outputs.connector }}-connector-v${{ steps.version.outputs.version }}.tar.gz",
            "checksum": {
              "type": "sha256",
              "value": "$CHECKSUM"
            },
            "source": {
              "hash": "$COMMIT_HASH"
            }
          }
          EOF

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "${{ steps.version.outputs.connector }} v${{ steps.version.outputs.version }}"
          generate_release_notes: true
          files: |
            ${{ steps.version.outputs.connector }}-connector-v${{ steps.version.outputs.version }}.tar.gz
            connector-packaging.json
